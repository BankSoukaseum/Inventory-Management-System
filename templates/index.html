<!DOCTYPE html>
<html>


<head>
    <title>Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <div class="container">
        <h1>Machi Inventory Update</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
            <div class="flash {{ category }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}


        <div class="actions">
            {% if session.get('user') %}
            <span class="user-info">
                Logged in as <strong>{{ session.get('user') }}</strong>
                ({{ session.get('role') }})
            </span>
        
            <a class="btn btn-logout" href="{{ url_for('logout') }}">Logout</a>
            {% endif %}
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
            <div class="flash flash-{{ category }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="get">
            <label for="category">Filter by category:</label>
            {% if session.get('role') == 'admin' %}
            <a class="btn btn-update" href="/add">+ Add Item</a>
            <a class="btn btn-update" href="{{ url_for('create_user') }}">+ Create User</a>
            <a class="btn btn-back" href="/audit">Audit Log</a>
            {% endif %}
            
            <button type="button" class="btn btn-back" onclick="expandAll()">Expand All</button>
            <button type="button" class="btn btn-back" onclick="collapseAll()">Collapse All</button>
            <select name="category" onchange="this.form.submit()">
                <option value="">All Categories</option>
        
                {% for cat in categories %}
                <option value="{{ cat['category'] }}" {% if selected_category==cat['category'] %}selected{% endif %}>
                    {{ cat['category'] }}
                </option>
                {% endfor %}
            </select>
        </form>

<div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search items..." onkeyup="searchItems()">
</div>

        <table>
            <tr>
                <th>Item</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Status</th>
                <th>Action</th>
            </tr>

        {% set ns = namespace(current_category=None) %}
        
        {% for item in items %}
        {% if item['category'] != ns.current_category %}
        <tr class="category-row" data-category-key="{{ item['category']
                | lower
                | replace(' ', '-')
                | replace('&', '')
            }}" data-expanded="true" onclick="toggleCategory(this)">



            <td colspan="6">
                <span class="arrow">▼</span> {{ item['category'] }}
            </td>
        </tr>
        {% set ns.current_category = item['category'] %}
        {% endif %}
        
        <tr class="item-row {{ item['status'] }} category-{{ item['category']
            | lower
            | replace(' ', '-')
            | replace('&', '')
        }}">

            <td>{{ item['name'] }}</td>
            <td>{{ item['category'] }}</td>
            <td>{{ item['quantity'] }}</td>
            <td>{{ item['unit'] }}</td>
            <td>
                {% if item['status'] == 'LOW' %}
                <span class="status-badge status-low">LOW</span>
                {% else %}
                <span class="status-badge status-ok">OK</span>
                {% endif %}
            </td>
            <td>
                {% if session.get('role') == 'admin' %}
                <a class="btn btn-update" href="/update/{{ item['id'] }}">Stock</a>
                <a class="btn btn-back" href="/edit/{{ item['id'] }}">Edit</a>
                <a class="btn btn-back" href="/delete/{{ item['id'] }}">Delete</a>
                {% else %}
                <span class="text-muted">View only</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}


        </table>
    </div>
<script>
    function toggleCategory(headerRow) {
        const key = headerRow.dataset.categoryKey;
        const rows = document.getElementsByClassName('category-' + key);
        const arrow = headerRow.querySelector('.arrow');

        const expanded = headerRow.dataset.expanded === "true";

        for (let row of rows) {
            row.style.display = expanded ? 'none' : '';
        }

        headerRow.dataset.expanded = expanded ? "false" : "true";
        arrow.textContent = expanded ? '▶' : '▼';
    }

    /* NEW: Expand all categories */
    function expandAll() {
        const headers = document.getElementsByClassName('category-row');

        for (let header of headers) {
            if (header.dataset.expanded === "false") {
                toggleCategory(header);
            }
        }
    }

    /* NEW: Collapse all categories */
    function collapseAll() {
        const headers = document.getElementsByClassName('category-row');

        for (let header of headers) {
            if (header.dataset.expanded === "true") {
                toggleCategory(header);
            }
        }
    }

    function searchItems() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.getElementsByClassName("item-row");

            for (let row of rows) {
                const nameCell = row.getElementsByTagName("td")[0];
                const text = nameCell.textContent.toLowerCase();
                row.style.display = text.includes(input) ? "" : "none";
            }
        }

</script>




</body>

</html>